
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chuchuzeiro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1b5e20">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            /* Palette iOS Green Flat Refined */
            --p: #2e7d32; /* Verde principal mais s√≥lido */
            --p-light: #4caf50;
            --p-dark: #1b5e20;
            --income: #2e7d32;
            --expense: #d32f2f; /* Vermelho iOS */
            --bg: #F5F7F8; /* Fundo off-white moderno */
            --card-bg: #FFFFFF;
            --input-bg: #F0F2F4; /* Input estilo iOS Gray */
            --radius: 20px; /* Curvas suaves */
            --shadow-soft: 0 8px 24px rgba(0, 0, 0, 0.04);
            --shadow-float: 0 12px 30px rgba(46, 125, 50, 0.25);
        }

        * { box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg);
            margin: 0;
            padding-bottom: 110px;
            color: #111;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        body.keyboard-open { padding-bottom: 20px !important; }
        body.keyboard-open nav { transform: translateY(150%); opacity: 0; pointer-events: none; }

        /* --- Header Clean Flat --- */
        header {
            background: var(--p);
            /* Removido gradiente complexo para look flat */
            color: white;
            padding: 15px 24px 60px;
            border-radius: 0 0 32px 32px; /* Curva mais acentuada */
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(46, 125, 50, 0.2);
            position: relative;
            z-index: 10;
        }
        
        .header-content { display: flex; flex-direction: column; justify-content: center; }
        
        .app-title { 
            font-weight: 800; 
            font-size: 1.5rem; /* Fonte maior para destaque */
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 2px;
        }
        
        /* User greeting oculto/removido visualmente conforme pedido, mas mantendo classe para nao quebrar js se referenciado */
        .user-greeting { 
            display: none; 
        }

        #status-tag {
            font-size: 0.7rem;
            font-weight: 600;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            backdrop-filter: blur(4px);
        }

        /* --- Dashboard Floating --- */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            padding: 0 24px;
            margin-top: -45px;
            position: relative;
            z-index: 20;
        }
        
        .dash-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 20px 16px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-soft);
            text-align: center;
            border: none;
        }
        
        .dash-card small { 
            color: #888; 
            font-size: 0.7rem; 
            text-transform: uppercase; 
            font-weight: 700; 
            letter-spacing: 0.5px; 
            margin-bottom: 4px; display: block;
        }
        .dash-card b { font-size: 1.25rem; display: block; color: #111; font-weight: 800; }
        .dash-card.full-width { grid-column: span 2; display: flex; flex-direction: row; justify-content: space-between; align-items: center; padding: 20px 24px; }

        .container { padding: 24px; max-width: 600px; margin: 0 auto; }
        
        .view { display: none; will-change: transform, opacity; }
        .view.active { display: block; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* --- Cards Modernos --- */
        .card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 24px; /* Mais arredondado */
            margin-bottom: 20px;
            box-shadow: var(--shadow-soft);
            border: none; /* Remove bordas para look clean */
        }

        h3 { 
            font-size: 1.1rem; 
            font-weight: 700; 
            color: #111; 
            margin: 0 0 20px 0; 
            display: flex; 
            align-items: center; 
            gap: 10px;
            letter-spacing: -0.3px;
        }

        /* --- Inputs iOS Style --- */
        label { font-size: 0.85rem; font-weight: 600; color: #666; margin-bottom: 8px; display: block; margin-left: 4px; }
        
        input, select {
            width: 100%;
            padding: 16px 16px;
            border-radius: 16px;
            border: none; /* Sem borda */
            background: var(--input-bg); /* Fundo cinza suave */
            margin-bottom: 20px;
            font-size: 1rem;
            color: #111;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        input:focus, select:focus {
            background: #fff;
            outline: none;
            box-shadow: 0 0 0 2px var(--p-light);
        }

        /* --- Bot√µes Modernos --- */
        button {
            width: 100%;
            padding: 16px;
            border-radius: 16px;
            border: none;
            font-weight: 700;
            font-size: 0.95rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.1s, opacity 0.2s;
            margin-bottom: 12px;
            letter-spacing: -0.2px;
        }
        button:active { transform: scale(0.98); }

        .btn-income { background: var(--income); color: white; box-shadow: 0 8px 20px rgba(46, 125, 50, 0.2); }
        .btn-expense { background: var(--expense); color: white; box-shadow: 0 8px 20px rgba(211, 47, 47, 0.2); }
        .btn-primary { background: var(--p); color: white; }
        .btn-sec { background: #E8EAED; color: #333; }
        .btn-update { background: #f59e0b; color: white; }
        .btn-delete { background: #FFF0F0; color: #D32F2F; }
        
        /* Bot√µes Especiais */
        .btn-backup-html { background: #007AFF; color: white; } /* Azul iOS */
        .btn-backup-json { background: #8E8E93; color: white; }
        .btn-install { background: #111; color: white; }

        /* --- BOT√ÉO FLUTUANTE DE SALVAR (VIRTUAL) --- */
        .fab-save {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: auto;
            padding: 14px 28px;
            background: var(--p);
            color: white;
            border-radius: 40px;
            box-shadow: var(--shadow-float);
            z-index: 2000;
            display: none; 
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 1rem;
            animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid rgba(255,255,255,0.2);
        }
        .fab-save:active { transform: scale(0.95); }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* --- Tiers Support --- */
        .tiers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 20px;
            margin-bottom: 15px;
        }
        .tier-card {
            background: white;
            border-radius: 20px;
            padding: 20px 14px;
            text-align: center;
            box-shadow: var(--shadow-soft);
            border: 1px solid transparent;
            position: relative;
            transition: transform 0.2s;
        }
        .tier-card:hover { transform: translateY(-3px); }
        .tier-icon { font-size: 2rem; margin-bottom: 8px; }
        .tier-title { font-weight: 800; color: var(--p); font-size: 0.9rem; margin-bottom: 4px; }
        .tier-price { font-weight: 700; font-size: 1rem; color: #111; margin-bottom: 6px; }
        .tier-description { font-size: 0.75rem; color: #666; margin-bottom: 12px; line-height: 1.4; }
        .tier-qr { width: 100px; height: 100px; object-fit: contain; margin: 0 auto; display: block; border-radius: 8px; }
        .zoom-hint { font-size: 0.7rem; color: var(--p); margin-top: 8px; cursor: pointer; font-weight: 700; }
        
        .badge-popular {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            background: var(--p); color: white; font-size: 0.65rem; font-weight: 800;
            padding: 4px 10px; border-radius: 20px; white-space: nowrap; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* --- Install Steps --- */
        .install-popup-content { text-align: left; }
        .install-section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .install-section:last-child { border-bottom: none; }
        .install-title { display: flex; align-items: center; gap: 8px; font-weight: 700; color: #111; margin-bottom: 8px; }
        .install-steps-list { font-size: 0.9rem; color: #555; line-height: 1.6; margin: 0; padding-left: 20px; }
        .step-highlight { background: #F0F2F4; padding: 2px 8px; border-radius: 6px; border: 1px solid #E1E3E5; font-weight: 600; color: #111; font-size: 0.8rem; }

        /* --- Navega√ß√£o Glass --- */
        nav {
            position: fixed; bottom: 20px; left: 16px; right: 16px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            z-index: 100;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .nav-buttons { display: flex; height: 70px; justify-content: space-around; align-items: center; }
        .tab { color: #A0A0A0; font-size: 0.7rem; font-weight: 600; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; flex: 1; transition: 0.3s; }
        .tab i { font-size: 1.3rem; margin-bottom: 2px; transition: 0.3s; }
        .tab.active { color: var(--p); }
        .tab.active i { transform: translateY(-4px); }

        /* --- Listas --- */
        .item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 16px 0; border-bottom: 1px solid #F0F2F4; 
        }
        .item:last-child { border-bottom: none; }
        .item-date-box { 
            background: #F0FDF4; padding: 8px 12px; border-radius: 12px; text-align: center; min-width: 50px; 
            color: var(--p);
        }
        .item-date-box strong { display: block; font-size: 1.1rem; line-height: 1; font-weight: 800; }
        .item-desc { margin-left: 16px; flex: 1; }
        .item-desc b { display: block; font-size: 0.95rem; color: #111; font-weight: 600; margin-bottom: 2px; }
        
        /* --- Modais --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(8px);
            z-index: 5000; display: none; align-items: center; justify-content: center; padding: 20px;
        }
        .glass-card {
            background: white; border-radius: 32px; padding: 32px; width: 100%; max-width: 360px;
            text-align: center; box-shadow: 0 30px 60px rgba(0,0,0,0.12);
            animation: popUp 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }
        @keyframes popUp { from { transform: scale(0.9) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }

        #toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: #222; color: white; padding: 12px 24px; border-radius: 40px;
            font-size: 0.9rem; font-weight: 600; opacity: 0; pointer-events: none; z-index: 6000; transition: 0.3s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        /* Tutorial List Better Styling */
        .tutorial-item { margin-bottom: 24px; border-bottom: 1px solid #F0F2F4; padding-bottom: 15px; }
        .tutorial-item:last-child { border: none; }
        .tutorial-head { display: flex; align-items: center; gap: 10px; color: var(--p); font-weight: 800; margin-bottom: 6px; font-size: 1rem; }
        .tutorial-body { font-size: 0.9rem; color: #555; line-height: 1.6; padding-left: 26px; }
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <div class="app-title" id="header-title">
                <i class="fas fa-leaf"></i> CHUCHUZEIRO
            </div>
            <div id="user-greeting" class="user-greeting"></div>
        </div>
        <div id="status-tag"><i class="fas fa-wifi"></i> OFF</div>
    </header>

    <div class="dashboard">
        <div class="dash-card">
            <small><i class="fas fa-box"></i> Caixas</small>
            <b id="dash-cx">0</b>
        </div>
        <div class="dash-card">
            <small><i class="fas fa-wallet"></i> L√≠quido</small>
            <b id="dash-rs">R$ 0,00</b>
        </div>
        <div class="dash-card full-width">
            <div>
                <small style="margin-bottom:0"><i class="fas fa-percentage"></i> Margem</small>
                <b id="dash-margin" style="font-size:1.2rem;">0%</b>
            </div>
            <div style="text-align: right;">
                <div style="font-size:0.75rem; color:var(--income)"><i class="fas fa-arrow-up"></i> <span id="dash-in">0</span></div>
                <div style="font-size:0.75rem; color:var(--expense)"><i class="fas fa-arrow-down"></i> <span id="dash-out">0</span></div>
            </div>
        </div>
    </div>

    <div id="welcome-modal" class="modal-overlay">
        <div class="glass-card">
            <div style="font-size: 3rem; margin-bottom: 10px;">üå±</div>
            <h2 style="color: var(--p); margin: 0 0 10px;">Bem-vindo!</h2>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">Como √© o nome do seu S√≠tio ou Neg√≥cio?</p>
            <input type="text" id="user-name-input" placeholder="Ex: S√≠tio Esperan√ßa, Z√© do Chuchu...">
            <button class="btn-primary" onclick="salvarUsuario()">Come√ßar a Usar</button>
        </div>
    </div>

    <div id="custom-modal" class="modal-overlay">
        <div class="glass-card">
            <span style="font-size: 2.5rem; display:block; margin-bottom:10px;" id="modal-icon">‚ö†Ô∏è</span>
            <h3 id="modal-title" style="margin-bottom: 8px;">Confirma√ß√£o</h3>
            <p id="modal-desc" style="font-size: 0.9rem; color: #666; margin-bottom: 20px;">Tem certeza?</p>
            <div style="display: flex; gap: 10px;">
                <button class="btn-sec" id="modal-btn-cancel">Cancelar</button>
                <button class="btn-primary" id="modal-btn-confirm">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="pix-modal" class="modal-overlay" onclick="closePixModal()">
        <div class="glass-card" onclick="event.stopPropagation()">
            <h3 id="modal-qr-title" style="color: var(--p); margin-top: 0;">Apoiar</h3>
            <div style="background: white; padding: 10px; border-radius: 10px; border: 1px solid #eee; display: inline-block;">
                <img id="modal-qr-img" src="" style="width: 250px; height: 250px; object-fit: contain; display: block;">
            </div>
            <p style="font-size: 0.8rem; color: #666; margin: 15px 0;">Escaneie no App do seu Banco</p>
            <button class="btn-sec" onclick="closePixModal()">Fechar</button>
        </div>
    </div>

    <div id="install-modal" class="modal-overlay">
        <div class="glass-card" style="max-width: 360px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0; color: var(--p);"><i class="fas fa-download"></i> Instalar App</h3>
                <i class="fas fa-times" onclick="document.getElementById('install-modal').style.display='none'" style="cursor: pointer; color: #999;"></i>
            </div>
            
            <div class="install-popup-content">
                <div class="install-section">
                    <div class="install-title"><i class="fab fa-apple" style="font-size: 1.2rem;"></i> iOS (iPhone/iPad)</div>
                    <ol class="install-steps-list">
                        <li>Toque no bot√£o <b>Compartilhar</b> <span class="step-highlight"><i class="fas fa-share-square"></i></span> na barra inferior.</li>
                        <li>Role para baixo e toque em <span class="step-highlight">Adicionar √† Tela de In√≠cio</span>.</li>
                        <li>Confirme clicando em <b>Adicionar</b>.</li>
                    </ol>
                </div>
                
                <div class="install-section">
                    <div class="install-title"><i class="fab fa-android" style="color: #3ddc84; font-size: 1.2rem;"></i> Android (Chrome)</div>
                    <ol class="install-steps-list">
                        <li>Toque no menu de <b>3 pontinhos</b> <span class="step-highlight"><i class="fas fa-ellipsis-v"></i></span> no topo.</li>
                        <li>Toque em <span class="step-highlight"><i class="fas fa-mobile-alt"></i> Instalar aplicativo</span> ou "Adicionar √† tela inicial".</li>
                        <li>Confirme a instala√ß√£o.</li>
                    </ol>
                </div>
            </div>

            <button class="btn-primary" onclick="document.getElementById('install-modal').style.display='none'">Entendi</button>
        </div>
    </div>
    
    <div id="tutorial-modal" class="modal-overlay">
        <div class="glass-card" style="max-height: 85vh; overflow-y: auto; text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: var(--p); margin: 0;"><i class="fas fa-book-open"></i> Manual do Produtor</h3>
                <i class="fas fa-times" onclick="document.getElementById('tutorial-modal').style.display='none'" style="cursor: pointer; color: #999;"></i>
            </div>
            
            <div class="tutorial-list">
                <div class="tutorial-item">
                    <div class="tutorial-head"><i class="fas fa-shield-alt"></i> 1. Novo Backup Offline</div>
                    <div class="tutorial-body">
                        Seguran√ßa total contra falta de internet! Ao clicar em <b>"Baixar App (HTML)"</b> na aba Relat√≥rios, voc√™ baixa um arquivo √∫nico que cont√©m o sistema e seus dados juntos. 
                        <br><br>
                        <b>Sem internet?</b> Basta abrir esse arquivo que baixou e continuar usando. Ele se auto-restaura.
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-head"><i class="fas fa-carrot"></i> 2. Controle de Colheita</div>
                    <div class="tutorial-body">
                        Na aba <b>Colheita</b>, registre quantas caixas vendeu, o pre√ßo da caixa e a data. O sistema calcula o valor total automaticamente e j√° soma no seu relat√≥rio mensal.
                    </div>
                </div>

                <div class="tutorial-item">
                    <div class="tutorial-head"><i class="fas fa-file-invoice-dollar"></i> 3. Relat√≥rios Profissionais</div>
                    <div class="tutorial-body">
                        Chega de caderninho! Gere <b>PDFs detalhados</b>. Voc√™ pode gerar o relat√≥rio s√≥ do M√™s atual ou da Safra (Ano) inteira para enviar para s√≥cios ou contabilidade.
                    </div>
                </div>
                
                <div class="tutorial-item">
                    <div class="tutorial-head"><i class="fas fa-wifi-slash"></i> 4. Modo Offline</div>
                    <div class="tutorial-body">
                        O app foi feito para a ro√ßa. Ele salva tudo na mem√≥ria do seu celular. N√£o precisa de sinal de celular para lan√ßar vendas ou despesas.
                    </div>
                </div>
            </div>
            <button class="btn-primary" onclick="document.getElementById('tutorial-modal').style.display='none'">Fechar Manual</button>
        </div>
    </div>

    <button id="fab-save" class="fab-save">
        <i class="fas fa-check"></i> <span>Confirmar</span>
    </button>

    <div class="container">
        
        <div id="v-venda" class="view active">
            <div class="card">
                <h3 id="titulo-venda"><i class="fas fa-seedling" style="color: var(--p);"></i> Registrar Venda</h3>
                <input type="hidden" id="venda-id">
                <label>Qtd. Caixas</label>
                <input type="number" id="q" placeholder="0" inputmode="numeric">
                <label>Pre√ßo Unit√°rio (R$)</label>
                <input type="number" id="p" placeholder="0,00" step="0.01" inputmode="decimal">
                <label>Data</label>
                <input type="date" id="dv">
                <button id="btn-acao-venda" class="btn-income" onclick="salvarVenda()">Confirmar Venda</button>
                <button id="btn-cancel-venda" class="btn-sec" style="display:none;" onclick="resetForm('vendas')">Cancelar</button>
            </div>
        </div>

        <div id="v-gasto" class="view">
            <div class="card">
                <h3 id="titulo-gasto"><i class="fas fa-tools" style="color: var(--expense);"></i> Registrar Despesa</h3>
                <input type="hidden" id="gasto-id">
                <label>Descri√ß√£o</label>
                <input type="text" id="d" placeholder="Adubo, Gasolina..." autocomplete="off">
                <label>Valor (R$)</label>
                <input type="number" id="v" placeholder="0,00" step="0.01" inputmode="decimal">
                <label>Data</label>
                <input type="date" id="dg">
                <button id="btn-acao-gasto" class="btn-expense" onclick="salvarGasto()">Registrar Gasto</button>
                <button id="btn-cancel-gasto" class="btn-sec" style="display:none;" onclick="resetForm('gastos')">Cancelar</button>
            </div>
        </div>

        <div id="v-consulta" class="view">
            <div class="card">
                <h3><i class="fas fa-chart-line" style="color: var(--p);"></i> Resultados</h3>
                <select id="filtroMes" onchange="render()"></select>
                
                <div style="background: #F0FDF4; padding: 20px; border-radius: 20px; margin-top: 10px; border: 1px solid #DCEDC8;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #555;">
                        <span>Safra <span id="lbl-ano-safra">2026</span></span>
                        <span>Acumulado</span>
                    </div>
                    <div style="text-align: center; font-size: 1.8rem; font-weight: 800; color: var(--p); margin: 10px 0;" id="safra-saldo-final">R$ 0,00</div>
                </div>
                <div style="height: 200px; width: 100%; margin-top: 20px;">
                    <canvas id="graficoLinha"></canvas>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-list"></i> Extrato</h3>
                <div id="lista-detalhada"></div>
            </div>

            <div class="card">
                <h3><i class="fas fa-database"></i> Dados & Backup</h3>
                
                <div id="backup-alert" style="display:none; background:#E3F2FD; color:#1565C0; padding:12px; border-radius:12px; margin-bottom:15px; font-size:0.85rem; align-items:center; gap:10px;">
                    <i class="fas fa-info-circle"></i> Backup recomendado (7 dias sem salvar).
                </div>

                <label style="margin-top:10px">Exportar App + Dados (HTML)</label>
                <button class="btn-backup-html" onclick="baixarAppOffline()">
                    <i class="fas fa-file-code"></i> Baixar App Completo (Offline)
                </button>
                <div style="font-size:0.75rem; color:#888; margin-bottom:15px; text-align:center;">
                    Gera um arquivo .html que abre mesmo sem internet e restaura seus dados.
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="btn-backup-json" onclick="exportarJsonVerify()">
                        <i class="fas fa-download"></i> Backup JSON
                    </button>
                    <button class="btn-sec" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-upload"></i> Restaurar JSON
                    </button>
                    <input type="file" id="fileInput" style="display:none" accept=".json" onchange="importarJsonVerify(event)">
                </div>

                <hr style="border:0; border-top:1px solid #F0F2F4; margin: 20px 0;">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="btn-sec" onclick="gerarPDF('mes')"><i class="fas fa-file-pdf"></i> PDF M√™s</button>
                    <button class="btn-sec" onclick="gerarPDF('ano')"><i class="fas fa-file-pdf"></i> PDF Safra</button>
                </div>

                <button class="btn-delete" style="margin-top: 20px;" onclick="confirmAction('Resetar App', 'ATEN√á√ÉO: Fa√ßa um backup manual antes! Isso apagar√° TODOS os dados, ignorar√° dados deste arquivo e o app iniciar√° do zero.', limparBancoDados, '‚ò¢Ô∏è', '#D32F2F')">
                    <i class="fas fa-trash"></i> Resetar Tudo (F√°brica)
                </button>
            </div>
        </div>

        <div id="v-apoie" class="view">
            <div class="card">
                <h3 style="margin:0; font-size: 1.1rem;"><i class="fas fa-rocket" style="color: var(--p);"></i> Guia & Instala√ß√£o</h3>
                <p style="font-size: 0.9rem; color: #666; margin: 10px 0;">Aprenda a usar todos os recursos e instale o app no seu celular.</p>
                
                <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                    <button class="btn-primary" onclick="document.getElementById('tutorial-modal').style.display='flex'">
                        <i class="fas fa-book"></i> Abrir Manual R√°pido
                    </button>
                    <button class="btn-install" onclick="document.getElementById('install-modal').style.display='flex'">
                        <i class="fas fa-mobile-alt"></i> Instalar App (PWA)
                    </button>
                </div>
            </div>

            <div class="card">
                <h4 style="color: var(--p); margin: 0 0 15px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-gift"></i> Escolha como fortalecer
                </h4>
                
                <div class="tiers-grid">
                    <div class="tier-card">
                        <div class="tier-icon">‚òï</div>
                        <div class="tier-title">O Caf√© da Firma</div>
                        <div class="tier-price">R$ 5,00</div>
                        <div class="tier-description">Ajuda a manter o dev acordado programando!</div>
                        <img src="qrcode.png" class="tier-qr" onclick="abrirQrCodeZoom(this.src, 'O Caf√© da Firma ‚òï')" onerror="this.src='https://placehold.co/200x200?text=QR+Code'">
                        <div class="zoom-hint" onclick="abrirQrCodeZoom(this.previousElementSibling.src, 'O Caf√© da Firma ‚òï')"><i class="fas fa-search-plus"></i> Ampliar</div>
                    </div>

                    <div class="tier-card" style="background: rgba(48, 209, 88, 0.08); border-color: var(--income);">
                        <div class="badge-popular">‚ú® Popular</div>
                        <div class="tier-icon">ü•™</div>
                        <div class="tier-title">O Lanche</div>
                        <div class="tier-price">R$ 15,00</div>
                        <div class="tier-description">Mais barato que taxa de banco! Retribua o valor.</div>
                        <img src="qrcode.png" class="tier-qr" onclick="abrirQrCodeZoom(this.src, 'O Lanche ü•™')" onerror="this.src='https://placehold.co/200x200?text=QR+Code'">
                        <div class="zoom-hint" onclick="abrirQrCodeZoom(this.previousElementSibling.src, 'O Lanche ü•™')"><i class="fas fa-search-plus"></i> Ampliar</div>
                    </div>

                    <div class="tier-card" style="background: rgba(255, 214, 10, 0.08); border-color: #ffd60a;">
                        <div class="tier-icon">üëë</div>
                        <div class="tier-title">Patr√£o do App</div>
                        <div class="tier-price">R$ 50,00+</div>
                        <div class="tier-description">Para quem virou f√£ e quer garantir o app pra sempre.</div>
                        <img src="qrcode.png" class="tier-qr" onclick="abrirQrCodeZoom(this.src, 'Patr√£o do App üëë')" onerror="this.src='https://placehold.co/200x200?text=QR+Code'">
                        <div class="zoom-hint" onclick="abrirQrCodeZoom(this.previousElementSibling.src, 'Patr√£o do App üëë')"><i class="fas fa-search-plus"></i> Ampliar</div>
                    </div>
                </div>

                <div class="app-footer" style="font-size: 0.75rem; color: #888; text-align: center; margin-top: 15px;">
                    <p>üåæ Feito para a ro√ßa: funciona 100% offline, sem sinal e sem nuvem.<br>
                    <strong>Privacidade Absoluta:</strong> Seus dados s√£o seus e n√£o saem do seu bolso.</p>
                </div>
            </div>
        </div>
    </div>

    <nav>
        <div class="nav-buttons">
            <div class="tab active" onclick="navTo('v-venda',this)"><i class="fas fa-seedling"></i><span>Colheita</span></div>
            <div class="tab" onclick="navTo('v-gasto',this)"><i class="fas fa-tools"></i><span>Despesas</span></div>
            <div class="tab" onclick="navTo('v-consulta',this)"><i class="fas fa-chart-pie"></i><span>Relat√≥rios</span></div>
            <div class="tab" onclick="navTo('v-apoie',this)"><i class="fas fa-heart"></i><span>Apoie</span></div>
        </div>
    </nav>

    <div id="toast">Notifica√ß√£o</div>

    <script id="offline-data" type="application/json"></script>

    <script>
        // --- 1. GEST√ÉO DE CONCORR√äNCIA (BroadcastChannel) ---
        const channel = new BroadcastChannel('chuchuzeiro_auth');
        channel.postMessage('check_alive');
        
        channel.onmessage = (event) => {
            if (event.data === 'i_am_alive') {
                document.body.innerHTML = `
                    <div style="display:flex; flex-direction:column; height:100vh; align-items:center; justify-content:center; text-align:center; padding:20px;">
                        <h1 style="color:#c62828">‚ö†Ô∏è App j√° aberto</h1>
                        <p>Para evitar erros no banco de dados, use apenas uma aba.</p>
                        <button onclick="window.close()" style="width:auto; background:#333; color:white; padding:10px 20px; border-radius:8px;">Fechar esta aba</button>
                    </div>`;
                if(db) db.close();
                throw new Error("Multi-tab detected");
            } else if (event.data === 'check_alive') {
                channel.postMessage('i_am_alive');
            }
        };

        // --- VARI√ÅVEIS GLOBAIS ---
        let db;
        let chartInstance;
        const DB_NAME = "ChuchuDB_V3";
        const DB_VERSION = 1;
        const FORMAT_BRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
        let pendingAction = null;

        // --- HELPERS UI ---
        function showToast(msg, type='success') {
            const t = document.getElementById("toast");
            t.innerText = (type==='error' ? '‚ùå ' : '‚úÖ ') + msg;
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 3000);
        }

        function getUserName() { return localStorage.getItem('user_name'); }
        
        function updateUserUI() {
            const name = getUserName();
            const el = document.getElementById('header-title');
            if(name) {
                // APENAS NOME, SEM ICONE CONFORME SOLICITADO
                el.innerHTML = `${name}`;
            }
        }

        // --- GEST√ÉO DE TECLADO E BOT√ÉO VIRTUAL ---
        function setupKeyboardHelpers() {
            const fab = document.getElementById('fab-save');
            const inputs = document.querySelectorAll('input');
            
            inputs.forEach(inp => {
                inp.addEventListener('focus', () => {
                    document.body.classList.add('keyboard-open');
                    
                    const activeView = document.querySelector('.view.active').id;
                    if(activeView === 'v-venda') {
                        fab.style.display = 'flex';
                        fab.style.background = 'var(--income)';
                        fab.innerHTML = '<i class="fas fa-check"></i> <span>Salvar Venda</span>';
                        fab.onclick = (e) => { e.preventDefault(); salvarVenda(); inp.blur(); };
                    } else if(activeView === 'v-gasto') {
                        fab.style.display = 'flex';
                        fab.style.background = 'var(--expense)';
                        fab.innerHTML = '<i class="fas fa-money-bill-wave"></i> <span>Salvar Gasto</span>';
                        fab.onclick = (e) => { e.preventDefault(); salvarGasto(); inp.blur(); };
                    }
                });

                inp.addEventListener('blur', () => {
                    setTimeout(() => {
                        const active = document.activeElement;
                        if(active.tagName !== 'INPUT') {
                            document.body.classList.remove('keyboard-open');
                            fab.style.display = 'none';
                        }
                    }, 150);
                });
            });
        }

        // --- CORE DATABASE (IndexedDB) ---
        function initDB() {
            try {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = e => {
                    db = e.target.result;
                    if(!db.objectStoreNames.contains("vendas")) db.createObjectStore("vendas", { keyPath: "id", autoIncrement: true });
                    if(!db.objectStoreNames.contains("gastos")) db.createObjectStore("gastos", { keyPath: "id", autoIncrement: true });
                };
                request.onsuccess = e => {
                    db = e.target.result;
                    checkOfflineRestore();
                    popularFiltroMeses();
                    render();
                };
                request.onerror = () => {
                    console.error("Erro DB");
                    showToast("Erro ao abrir Banco de Dados", "error");
                    if(!getUserName()) document.getElementById('welcome-modal').style.display = 'flex';
                };
            } catch(e) {
                console.error("DB Init Error", e);
            }
        }

        function transaction(store, mode) { return db.transaction(store, mode).objectStore(store); }
        
        function getAll(store) {
            return new Promise((resolve, reject) => {
                const req = transaction(store, "readonly").getAll();
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }

        // --- BACKUP OFFLINE (HTML INJECTION) ---
        async function baixarAppOffline() {
            showToast("Verificando dados...", "success");
            
            try {
                const vendas = await getAll("vendas");
                const gastos = await getAll("gastos");
                
                if(!vendas && !gastos) throw new Error("Erro na leitura");

                const payload = JSON.stringify({ vendas, gastos, user: getUserName(), date: new Date().toISOString() });
                
                const clone = document.documentElement.cloneNode(true);
                const scriptTag = clone.querySelector('#offline-data');
                scriptTag.textContent = payload;
                
                const blob = new Blob([clone.outerHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Chuchuzeiro_OFFLINE_${new Date().toISOString().slice(0,10)}.html`;
                a.click();
                
                showToast("App Completo baixado!");
            } catch (e) {
                console.error(e);
                showToast("Erro ao gerar backup HTML", "error");
            }
        }

        function checkOfflineRestore() {
            if (localStorage.getItem('ignore_embed') === 'true') {
                console.log("Ignorando dados embutidos devido ao Hard Reset.");
                return;
            }

            const scriptTag = document.getElementById('offline-data');
            if (scriptTag && scriptTag.textContent.trim().length > 0) {
                try {
                    const data = JSON.parse(scriptTag.textContent);
                    console.log("Vers√£o Offline Detectada. Restaurando...");
                    
                    if(data.user) localStorage.setItem('user_name', data.user);
                    updateUserUI();

                    const tx = db.transaction(["vendas", "gastos"], "readwrite");
                    tx.objectStore("vendas").clear();
                    tx.objectStore("gastos").clear();
                    data.vendas.forEach(i => tx.objectStore("vendas").put(i));
                    data.gastos.forEach(i => tx.objectStore("gastos").put(i));
                    
                    showToast("Dados restaurados do arquivo!", "success");
                } catch (e) {
                    console.error("Falha na auto-restaura√ß√£o. Script vazio ou corrompido.", e);
                }
            }
        }

        // --- BACKUP JSON VERIFICADO ---
        async function exportarJsonVerify() {
            try {
                const vendas = await getAll("vendas");
                const gastos = await getAll("gastos");
                if(!Array.isArray(vendas) || !Array.isArray(gastos)) throw new Error("Estrutura inv√°lida");
                
                const blob = new Blob([JSON.stringify({vendas, gastos})], {type: "application/json"});
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = `Backup_JSON_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                showToast("Backup JSON verificado e salvo!");
            } catch(e) { showToast("Erro nos dados. Contate suporte.", "error"); }
        }

        function importarJsonVerify(e) {
            const file = e.target.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = f => {
                try {
                    const d = JSON.parse(f.target.result);
                    if(!d.vendas || !d.gastos) throw new Error("JSON Inv√°lido");
                    
                    confirmAction("Restaurar JSON", "Verificamos o arquivo e parece ok. Substituir dados?", () => {
                        const tx = db.transaction(["vendas", "gastos"], "readwrite");
                        d.vendas.forEach(i => { delete i.id; tx.objectStore("vendas").put(i); });
                        d.gastos.forEach(i => { delete i.id; tx.objectStore("gastos").put(i); });
                        tx.oncomplete = () => { showToast("Restaurado!"); render(); };
                    }, 'üì•');
                } catch(err) { showToast("Arquivo corrompido ou inv√°lido", "error"); }
            };
            reader.readAsText(file);
        }

        // --- FUN√á√ïES DE CRUD ---
        function salvarVenda() {
            const q = parseFloat(document.getElementById('q').value);
            const p = parseFloat(document.getElementById('p').value);
            const dt = document.getElementById('dv').value;
            const id = document.getElementById('venda-id').value;
            
            if(!q || !p || !dt) return showToast("Preencha tudo", "error");
            
            const item = { q, p, dt, t: q*p };
            if(id) item.id = parseInt(id);
            
            transaction("vendas", "readwrite").put(item).onsuccess = () => {
                showToast("Salvo!");
                resetForm('vendas');
                render();
            };
        }

        function salvarGasto() {
            const d = document.getElementById('d').value;
            const v = parseFloat(document.getElementById('v').value);
            const dt = document.getElementById('dg').value;
            const id = document.getElementById('gasto-id').value;
            
            if(!d || !v || !dt) return showToast("Preencha tudo", "error");
            
            const item = { d, v, dt };
            if(id) item.id = parseInt(id);
            
            transaction("gastos", "readwrite").put(item).onsuccess = () => {
                showToast("Salvo!");
                resetForm('gastos');
                render();
            };
        }

        function resetForm(type) {
            const hoje = new Date().toISOString().split('T')[0];
            if(type === 'vendas') {
                document.getElementById('venda-id').value = "";
                document.getElementById('q').value = "";
                document.getElementById('p').value = "";
                document.getElementById('dv').value = hoje;
                document.getElementById('btn-acao-venda').innerText = "Confirmar Venda";
                document.getElementById('btn-acao-venda').className = "btn-income";
                document.getElementById('btn-cancel-venda').style.display = "none";
            } else {
                document.getElementById('gasto-id').value = "";
                document.getElementById('d').value = "";
                document.getElementById('v').value = "";
                document.getElementById('dg').value = hoje;
                document.getElementById('btn-acao-gasto').innerText = "Registrar Gasto";
                document.getElementById('btn-acao-gasto').className = "btn-expense";
                document.getElementById('btn-cancel-gasto').style.display = "none";
            }
        }

        function editarItem(type, id) {
            transaction(type, "readonly").get(id).onsuccess = e => {
                const d = e.target.result;
                if(type === 'vendas') {
                    navTo('v-venda', document.querySelectorAll('.tab')[0]);
                    document.getElementById('venda-id').value = d.id;
                    document.getElementById('q').value = d.q;
                    document.getElementById('p').value = d.p;
                    document.getElementById('dv').value = d.dt;
                    document.getElementById('btn-acao-venda').innerText = "Salvar Altera√ß√£o";
                    document.getElementById('btn-acao-venda').className = "btn-update";
                    document.getElementById('btn-cancel-venda').style.display = "block";
                } else {
                    navTo('v-gasto', document.querySelectorAll('.tab')[1]);
                    document.getElementById('gasto-id').value = d.id;
                    document.getElementById('d').value = d.d;
                    document.getElementById('v').value = d.v;
                    document.getElementById('dg').value = d.dt;
                    document.getElementById('btn-acao-gasto').innerText = "Salvar Altera√ß√£o";
                    document.getElementById('btn-acao-gasto').className = "btn-update";
                    document.getElementById('btn-cancel-gasto').style.display = "block";
                }
            };
        }

        // --- RENDERIZA√á√ÉO ---
        async function render() {
            if(!db) return;
            const filtro = document.getElementById('filtroMes').value;
            const allV = await getAll("vendas");
            const allG = await getAll("gastos");
            
            const v = allV.filter(i => i.dt.startsWith(filtro));
            const g = allG.filter(i => i.dt.startsWith(filtro));
            
            const tV = v.reduce((s,i)=>s+i.t,0);
            const tG = g.reduce((s,i)=>s+i.v,0);
            const cx = v.reduce((s,i)=>s+i.q,0);
            const saldo = tV - tG;
            const margem = tV > 0 ? ((saldo/tV)*100).toFixed(0) : 0;
            
            document.getElementById('dash-cx').innerText = cx;
            document.getElementById('dash-rs').innerText = FORMAT_BRL.format(saldo);
            document.getElementById('dash-rs').style.color = saldo >= 0 ? 'var(--income)' : 'var(--expense)';
            document.getElementById('dash-margin').innerText = margem + "%";
            document.getElementById('dash-in').innerText = FORMAT_BRL.format(tV);
            document.getElementById('dash-out').innerText = FORMAT_BRL.format(tG);

            const ano = filtro.split('-')[0];
            const tVSafra = allV.filter(i=>i.dt.startsWith(ano)).reduce((s,i)=>s+i.t,0);
            const tGSafra = allG.filter(i=>i.dt.startsWith(ano)).reduce((s,i)=>s+i.v,0);
            document.getElementById('lbl-ano-safra').innerText = ano;
            document.getElementById('safra-saldo-final').innerText = FORMAT_BRL.format(tVSafra - tGSafra);

            const lista = document.getElementById('lista-detalhada');
            lista.innerHTML = "";
            const items = [...v.map(i=>({...i, type:'vendas'})), ...g.map(i=>({...i, type:'gastos'}))]
                         .sort((a,b) => new Date(b.dt) - new Date(a.dt));
            
            if(items.length === 0) lista.innerHTML = "<div style='text-align:center; padding:20px; color:#aaa'>Sem registros.</div>";
            
            items.forEach(i => {
                const el = document.createElement('div');
                el.className = 'item';
                const isV = i.type === 'vendas';
                const [y,m,d] = i.dt.split('-');
                el.innerHTML = `
                    <div class="item-date-box"><strong>${d}</strong></div>
                    <div class="item-desc">
                        <b>${isV ? i.q + ' Cx' : i.d}</b>
                        <span style="font-size:0.75rem; color:#666">${isV ? FORMAT_BRL.format(i.p) : 'Despesa'}</span>
                    </div>
                    <div style="text-align:right">
                        <b style="color:${isV ? 'var(--income)':'var(--expense)'}">${isV?'+':'-'} ${FORMAT_BRL.format(isV?i.t:i.v)}</b>
                        <div style="margin-top:4px">
                            <i class="fas fa-pen" style="color:#0284c7; margin-right:8px; cursor:pointer;" onclick="editarItem('${i.type}', ${i.id})"></i>
                            <i class="fas fa-trash" style="color:#ef4444; cursor:pointer;" onclick="confirmAction('Apagar', 'Apagar este item?', ()=>apagarItem('${i.type}', ${i.id}))"></i>
                        </div>
                    </div>
                `;
                lista.appendChild(el);
            });
            
            renderChart(v);
        }

        function apagarItem(type, id) {
            transaction(type, "readwrite").delete(id).onsuccess = () => { showToast("Apagado"); render(); };
        }

        function renderChart(vendas) {
            const ctx = document.getElementById('graficoLinha').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            
            const map = {};
            vendas.forEach(v => { const d = parseInt(v.dt.split('-')[2]); map[d] = (map[d]||0) + v.q; });
            const labels = Object.keys(map).sort((a,b)=>a-b);
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Caixas',
                        data: labels.map(l=>map[l]),
                        borderColor: '#2e7d32',
                        backgroundColor: 'rgba(46, 125, 50, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}} }
            });
        }

        async function popularFiltroMeses() {
            const select = document.getElementById('filtroMes');
            const atual = select.value;
            select.innerHTML = "";
            const mesAtual = new Date().toISOString().slice(0,7);
            
            for(let i=0; i<12; i++) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                const val = d.toISOString().slice(0,7);
                const nome = d.toLocaleString('pt-BR', {month:'long', year:'numeric'});
                const opt = document.createElement('option');
                opt.value = val;
                opt.innerText = nome.charAt(0).toUpperCase() + nome.slice(1);
                select.appendChild(opt);
            }
            if(atual) select.value = atual;
        }

        // --- SISTEMA ---
        function limparBancoDados() {
            if(db) db.close();
            const req = indexedDB.deleteDatabase(DB_NAME);
            req.onsuccess = () => {
                localStorage.clear();
                localStorage.setItem('ignore_embed', 'true');
                alert("App resetado! O sistema iniciar√° do zero.");
                location.reload();
            };
        }

        function salvarUsuario() {
            const nome = document.getElementById('user-name-input').value;
            if(!nome) return;
            localStorage.setItem('user_name', nome);
            document.getElementById('welcome-modal').style.display = 'none';
            updateUserUI();
        }

        function navTo(view, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(view).classList.add('active');
            el.classList.add('active');
            if(view === 'v-consulta') render();
        }

        // --- CONFIRMA√á√ÉO ---
        function confirmAction(title, desc, action, icon='‚ö†Ô∏è', color=null) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-desc').innerText = desc;
            document.getElementById('modal-icon').innerText = icon;
            const btn = document.getElementById('modal-btn-confirm');
            if(color) btn.style.background = color;
            
            pendingAction = action;
            document.getElementById('custom-modal').style.display = 'flex';
        }
        document.getElementById('modal-btn-cancel').onclick = () => document.getElementById('custom-modal').style.display = 'none';
        document.getElementById('modal-btn-confirm').onclick = () => {
            if(pendingAction) pendingAction();
            document.getElementById('custom-modal').style.display = 'none';
        };

        function abrirQrCodeZoom(src, title) {
            document.getElementById('modal-qr-img').src = src;
            document.getElementById('modal-qr-title').innerText = title;
            document.getElementById('pix-modal').style.display = 'flex';
        }
        function closePixModal() { document.getElementById('pix-modal').style.display = 'none'; }
        
        // --- PDF ---
        async function gerarPDF(tipo) {
            showToast("Gerando PDF...");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`Relat√≥rio Chuchuzeiro - ${getUserName() || ''}`, 10, 10);
            doc.text(`Gerado em: ${new Date().toLocaleDateString()}`, 10, 20);
            
            const filtro = document.getElementById('filtroMes').value;
            const itens = [];
            const allV = await getAll("vendas");
            const allG = await getAll("gastos");
            
            const target = tipo === 'ano' ? filtro.split('-')[0] : filtro;
            
            allV.filter(i=>i.dt.startsWith(target)).forEach(i => {
                itens.push([i.dt, "Venda: "+i.q+" cx", `+ ${FORMAT_BRL.format(i.t)}`]);
            });
            allG.filter(i=>i.dt.startsWith(target)).forEach(i => {
                itens.push([i.dt, i.d, `- ${FORMAT_BRL.format(i.v)}`]);
            });
            
            doc.autoTable({ head: [['Data', 'Desc', 'Valor']], body: itens, startY: 30 });
            doc.save('Relatorio.pdf');
        }

        // --- INIT ---
        window.onload = () => {
            initDB();
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dv').value = hoje;
            document.getElementById('dg').value = hoje;
            
            setupKeyboardHelpers();

            if(!getUserName()) document.getElementById('welcome-modal').style.display = 'flex';
            else updateUserUI();

            window.addEventListener('online',  updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();
        };

        function updateOnlineStatus() {
            const tag = document.getElementById('status-tag');
            if(navigator.onLine) {
                tag.innerHTML = '<i class="fas fa-cloud"></i> ON';
                tag.style.background = "rgba(255,255,255,0.2)";
            } else {
                tag.innerHTML = '<i class="fas fa-wifi-slash"></i> OFF';
                tag.style.background = "#ef4444";
            }
        }
    </script>
</body>
</html>
