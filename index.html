
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chuchuzeiro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1b5e20">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --p: #1b5e20;
            --p-dark: #0e3d12;
            --income: #1b5e20;
            --expense: #c62828;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --radius: 20px;
            --chart-line: #1b5e20;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg);
            margin: 0;
            padding-bottom: 110px;
            color: #111;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .gpu-accelerated {
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
        }

        /* Header com gradiente verde */
        header {
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            color: white;
            padding: 20px 24px 70px;
            border-radius: 0 0 36px 36px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(27, 94, 32, 0.3);
            position: relative;
            z-index: 10;
        }
        .header-content { display: flex; flex-direction: column; justify-content: center; }
        .app-title { font-weight: 800; font-size: 1.2rem; }
        .user-greeting { font-size: 0.8rem; font-weight: 500; opacity: 0.9; margin-top: 4px; display: none; }

        /* Dashboard 2+1 cards */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            padding: 0 24px;
            margin-top: -50px;
            position: relative;
            z-index: 20;
        }
        .dash-card {
            background: var(--card-bg);
            padding: 20px 16px;
            border-radius: var(--radius);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
            text-align: center;
            contain: content;
            transform: translateZ(0);
        }
        .dash-card small { color: #6b7280; font-size: 0.7rem; text-transform: uppercase; font-weight: 700; }
        .dash-card b { font-size: 1.2rem; display: block; margin-top: 5px; }
        .dash-card.full-width { grid-column: span 2; display: flex; flex-direction: row; justify-content: space-between; align-items: center; padding: 16px 24px; }

        .container { padding: 20px; max-width: 600px; margin: 0 auto; }

        .view { display: none; will-change: transform, opacity; }
        .view.active { display: block; animation: fadeIn 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.08);
            transform: translateZ(0);
            transition: transform 0.2s;
        }
        .card:active { transform: scale(0.99) translateZ(0); }

        input, select { 
             width: 100%; 
             padding: 14px; 
             border-radius: 12px; 
             border: 1px solid #e5e7eb; 
             background: #f9fafb; 
             margin-bottom: 15px; 
             font-size: 16px; 
             transition: all 0.2s;
        }
        input:focus, select:focus { 
             border-color: var(--p); 
             box-shadow: 0 0 0 3px rgba(27,94,32,0.1); 
             outline: none; 
             background: white;
        }

        button { 
             width: 100%; 
             padding: 15px; 
             border-radius: 12px; 
             border: none; 
             font-weight: 700; 
             cursor: pointer; 
             display: flex; 
             align-items: center; 
             justify-content: center; 
             gap: 8px; 
             transition: all 0.2s; 
         }
        button:active { transform: scale(0.98); opacity: 0.9; }

        .btn-income { background: var(--income); color: white; }
        .btn-expense { background: var(--expense); color: white; }
        .btn-delete { background: #fff1f2; color: #e11d48; margin-top: 10px; border: 1px solid #fecaca; }
        .btn-sec { background: #f3f4f6; color: #4b5563; }
        .btn-primary { background: var(--p); color: white; }
        .btn-pix { background: #32bcad; color: white; }
        .btn-mp { background: #009ee3; color: white; }
        .btn-wpp { background: #25d366; color: white; }
        .btn-tutorial { background: #8b5cf6; color: white; }
        .btn-pdf { background: #374151; color: white; }
        .btn-update { background: #f59e0b; color: white; }

        /* Navega√ß√£o inferior flutuante - GLASS AJUSTADO */
        nav {
            position: fixed; bottom: 20px; left: 16px; right: 16px;
            background: rgba(255, 255, 255, 0.70); /* Mais transparente */
            backdrop-filter: blur(15px); /* Mais blur */
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 100;
            transform: translateZ(0);
        }
        .nav-buttons { display: flex; height: 70px; justify-content: space-around; align-items: center; }
        .tab { color: #6b7280; font-size: 0.65rem; font-weight: 600; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; flex: 1; transition: color 0.2s; }
        .tab.active { color: var(--p); }
        .tab i { font-size: 1.2rem; margin-bottom: 2px; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .tab.active i { transform: translateY(-3px); }

        /* Lista de registros */
        .item { 
             display: flex; 
             justify-content: space-between; 
             padding: 15px 0; 
             border-bottom: 1px solid #f3f4f6; 
             cursor: pointer; 
             transition: background 0.1s;
            align-items: center;
        }
        .item:hover { background: #fafafa; }
        .item-date-box {
            background: #f3f4f6; padding: 6px 10px; border-radius: 8px; text-align: center; min-width: 50px;
        }
        .item-date-box span { display: block; font-size: 0.7rem; color: #666; text-transform: uppercase; }
        .item-date-box strong { display: block; font-size: 1.1rem; color: #333; line-height: 1; margin-top: 2px; }
        .item-desc { margin-left: 12px; flex: 1; }
        .item-desc b { display: block; font-size: 0.95rem; color: #1f2937; margin-bottom: 2px; }
        .item-desc small { color: #6b7280; font-size: 0.8rem; }

        /* Toast */
        #toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateZ(0);
            background: #333; color: white; padding: 12px 24px; border-radius: 50px;
            opacity: 0; transition: opacity 0.3s; z-index: 2000; pointer-events: none;
            will-change: opacity; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        /* Gr√°fico */
        canvas { 
             transform: translateZ(0); 
             max-height: 250px; 
             width: 100% !important; 
         }

        /* MODAIS GLASS (tutorial, pix, boas vindas, RELATORIOS) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(6px);
            z-index: 5000; display: none; align-items: center; justify-content: center;
            padding: 20px;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            padding: 30px 20px; border-radius: 30px;
            text-align: center; width: 100%; max-width: 340px;
            transform: translateZ(0);
            animation: floatUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .glass-input {
            background: rgba(255,255,255,0.8);
            border: 2px solid transparent;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
            text-align: center;
        }
        .glass-input:focus { border-color: var(--p); background: white; }

        @keyframes floatUp {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* Tutorial */
        .tutorial-list { text-align: left; padding-left: 0; list-style: none; margin: 10px 0; }
        .tutorial-list h4 { margin: 20px 0 8px; color: var(--p); font-size: 0.95rem; font-weight: 700; display: flex; align-items: center; gap: 6px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; }
        .tutorial-list ul { padding-left: 20px; margin: 0 0 5px 0; list-style: none; }
        .tutorial-list li { margin-bottom: 10px; font-size: 0.8rem; color: #4b5563; display: flex; gap: 10px; align-items: flex-start; line-height: 1.4; }
        .tutorial-list li i { color: var(--p); margin-top: 2px; min-width: 18px; text-align: center; }

        /* Backup alert */
        .backup-alert { background: #eff6ff; border: 1px solid #dbeafe; padding: 12px 16px; border-radius: 12px; margin-bottom: 20px; display: none; align-items: center; justify-content: space-between; }

        /* Info e privacidade */
        .info-section { font-size: 0.85rem; line-height: 1.5; color: #4b5563; }
        .privacy-box { background: #f0fdf4; border: 1px solid #10b981; padding: 15px; border-radius: 15px; margin-top: 15px; color: #065f46; }

        /* Modal de confirma√ß√£o (Reset) - CORRIGIDO */
        #custom-modal .modal-box { 
            background: rgba(255, 255, 255, 0.85); /* Fundo Glass */
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.5);
            width: 85%; 
            max-width: 320px; 
            padding: 24px; 
            border-radius: 20px; 
            text-align: center; 
            transform: scale(0.9); 
            transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); 
        }
        #custom-modal.open { display: flex; }
        .modal-icon { font-size: 2.5rem; margin-bottom: 10px; display: block; }
        .modal-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 8px; color: #111; }
        .modal-actions {
            display: flex;
            gap: 15px; /* Espa√ßo entre os bot√µes */
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <header class="gpu-accelerated">
        <div class="header-content">
            <div class="app-title"><i class="fas fa-leaf"></i> CHUCHUZEIRO</div>
            <div id="user-greeting" class="user-greeting"></div>
        </div>
        <div id="status-tag"><i class="fas fa-cloud-sun"></i> ONLINE</div>
    </header>

    <div class="dashboard">
        <div class="dash-card">
            <small><i class="fas fa-boxes"></i> Volume M√™s</small>
            <b id="dash-cx">0</b>
            <span style="font-size:0.7rem; color:#666">caixas</span>
        </div>
        <div class="dash-card">
            <small><i class="fas fa-coins"></i> Saldo L√≠quido</small>
            <b id="dash-rs">R$ 0,00</b>
        </div>
        <div class="dash-card full-width">
            <div>
                <small style="margin-bottom:0"><i class="fas fa-chart-line"></i> Margem de Lucro</small>
                <b id="dash-margin" style="font-size:1.2rem;">0%</b>
            </div>
            <div style="text-align: right;">
                <div style="font-size:0.75rem; color:var(--p)"><i class="fas fa-arrow-up"></i> Entrada: <span id="dash-in">R$ 0</span></div>
                <div style="font-size:0.75rem; color:var(--expense)"><i class="fas fa-arrow-down"></i> Sa√≠da: <span id="dash-out">R$ 0</span></div>
            </div>
        </div>
    </div>

    <div id="welcome-modal" class="modal-overlay">
        <div class="glass-card">
            <div style="font-size: 3rem; margin-bottom: 10px;">üå±</div>
            <h2 style="color: var(--p); margin: 0 0 10px;">Bem-vindo(a)!</h2>
            <p style="color: #4b5563; font-size: 0.9rem; margin-bottom: 20px;">
                Como voc√™ quer ser chamado(a) nos relat√≥rios?
            </p>
            <input type="text" id="user-name-input" class="glass-input" placeholder="Ex: S√≠tio Esperan√ßa, Sr. Jo√£o...">
            <button class="btn-primary" onclick="salvarUsuario()">Come√ßar</button>
        </div>
    </div>

    <div id="modal-relatorios" class="modal-overlay">
        <div class="glass-card">
            <h3 style="color: var(--p); margin-top: 0;"><i class="fas fa-file-invoice"></i> Relat√≥rios</h3>
            <p style="font-size: 0.85rem; color: #4b5563; margin-bottom: 20px;">
                Escolha o tipo de relat√≥rio que deseja exportar em PDF:
            </p>
            
            <button class="btn-primary" onclick="gerarRelatorioPDF()" style="margin-bottom: 12px; background: #374151;">
                <i class="fas fa-calendar-alt"></i> Relat√≥rio Mensal
            </button>

            <button class="btn-primary" onclick="gerarRelatorioSafraPDF()" style="margin-bottom: 20px; background: var(--p);">
                <i class="fas fa-layer-group"></i> Relat√≥rio Safra Anual
            </button>

            <button class="btn-sec" onclick="fecharModalRelatorios()">
                Cancelar
            </button>
        </div>
    </div>

    <div id="tutorial-modal" class="modal-overlay">
        <div class="glass-card" style="max-height: 85vh; overflow-y: auto; padding: 25px 20px; text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="color: var(--p); margin: 0; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-book-open"></i> Guia Completo
                </h3>
                <i class="fas fa-times" onclick="closeTutorialModal()" style="font-size: 1.5rem; color: #9ca3af; cursor: pointer;"></i>
            </div>
            
            <div class="tutorial-list">
                <h4><i class="fas fa-seedling"></i> Registrar Colheita (Venda)</h4>
                <ul>
                    <li><i class="fas fa-pencil-alt"></i> <div><b>Aba "Colheita":</b> informe a quantidade de caixas, pre√ßo por caixa e data.</div></li>
                    <li><i class="fas fa-check-circle"></i> <div>Clique em <strong>"Confirmar Venda"</strong>. O valor total √© calculado automaticamente.</div></li>
                    <li><i class="fas fa-edit"></i> <div>Para editar, clique sobre o item na aba "Relat√≥rios".</div></li>
                </ul>

                <h4><i class="fas fa-tools"></i> Registrar Despesas</h4>
                <ul>
                    <li><i class="fas fa-pencil-alt"></i> <div><b>Aba "Despesas":</b> descreva o gasto, valor e data.</div></li>
                    <li><i class="fas fa-check-circle"></i> <div>Clique em <strong>"Registrar Gasto"</strong>.</div></li>
                    <li><i class="fas fa-edit"></i> <div>Edi√ß√£o r√°pida: toque no extrato e altere os dados.</div></li>
                </ul>

                <h4><i class="fas fa-chart-pie"></i> Relat√≥rios e Gr√°ficos</h4>
                <ul>
                    <li><i class="fas fa-calendar-alt"></i> <div><b>Filtro por m√™s:</b> selecione o per√≠odo no topo da aba "Relat√≥rios".</div></li>
                    <li><i class="fas fa-chart-line"></i> <div><b>Gr√°fico de linhas:</b> mostra a quantidade de caixas vendidas por dia no m√™s.</div></li>
                    <li><i class="fas fa-tachometer-alt"></i> <div><b>Dashboard:</b> volume, saldo, margem de lucro e entradas/sa√≠das.</div></li>
                    <li><i class="fas fa-list-ul"></i> <div><b>Extrato completo:</b> todas as vendas e despesas do m√™s, com edi√ß√£o.</div></li>
                </ul>

                <h4><i class="fas fa-file-pdf"></i> Backup e Relat√≥rios</h4>
                <ul>
                    <li><i class="fas fa-file-pdf"></i> <div><b>PDF profissional:</b> relat√≥rio mensal com tabelas, resumo e cabe√ßalho personalizado.</div></li>
                    <li><i class="fab fa-whatsapp"></i> <div><b>Enviar no WhatsApp:</b> compartilhe o PDF ou um resumo com seu contador/s√≥cio.</div></li>
                    <li><i class="fas fa-database"></i> <div><b>Backup JSON:</b> exporte seus dados para guardar no e-mail, Drive ou PC.</div></li>
                    <li><i class="fas fa-upload"></i> <div><b>Importar:</b> restaure um backup anterior a qualquer momento.</div></li>
                    <li><i class="fas fa-bell"></i> <div><b>Alerta de backup:</b> se passarem 7 dias sem backup, o app lembra voc√™.</div></li>
                </ul>

                <h4><i class="fas fa-microchip"></i> Recursos Avan√ßados</h4>
                <ul>
                    <li><i class="fas fa-mobile-alt"></i> <div><b>Instale como App (PWA):</b> no Chrome, use "Adicionar √† tela inicial".</div></li>
                    <li><i class="fas fa-wifi-slash"></i> <div><b>Funciona offline:</b> use no campo, sem internet ‚Äì os dados ficam no seu celular.</div></li>
                    <li><i class="fas fa-user-secret"></i> <div><b>Privacidade radical:</b> NENHUM dado sai do seu dispositivo (IndexedDB).</div></li>
                </ul>

                <h4><i class="fas fa-heart"></i> Apoie o Projeto</h4>
                <ul>
                    <li><i class="fas fa-qrcode"></i> <div><b>PIX:</b> QR Code na aba "Apoie".</div></li>
                    <li><i class="fas fa-credit-card"></i> <div><b>Mercado Pago:</b> doe com cart√£o ou boleto.</div></li>
                    <li><i class="fab fa-whatsapp"></i> <div><b>Contato direto:</b> fale com o desenvolvedor.</div></li>
                    <li><i class="fas fa-book-reader"></i> <div><b>Tutorial:</b> este guia est√° sempre dispon√≠vel na aba Apoie.</div></li>
                </ul>
            </div>
            
            <button class="btn-primary" onclick="closeTutorialModal()" style="margin-top: 20px; width: 100%;">
                <i class="fas fa-check"></i> Entendi, vamos l√°!
            </button>
        </div>
    </div>

    <div id="pix-modal" class="modal-overlay">
        <div class="glass-card">
            <h3 style="color: var(--p); margin-top: 0;">Mantenha o projeto vivo ‚òï</h3>
            <div style="background: white; padding: 15px; border-radius: 15px; display: inline-block; margin: 10px 0;">
                <img src="qrcode.png" alt="QR Code PIX" style="width: 200px; height: 200px; object-fit: contain; display: block;" onerror="this.src='https://placehold.co/200x200?text=QR+Code+PIX'">
            </div>
            <p style="font-size: 0.85rem; color: #4b5563; margin-bottom: 20px; line-height: 1.5;">
                Sua doa√ß√£o mant√©m o Chuchuzeiro gratuito e sem an√∫ncios.<br>
                <b>Escaneie e fa√ßa um PIX</b>
            </p>
            <button class="btn-primary" onclick="closePixModal()" style="background: #374151;">
                <i class="fas fa-times"></i> Fechar
            </button>
        </div>
    </div>

    <div class="container">

        <div id="v-venda" class="view active">
            <div class="card">
                <h3 id="titulo-venda"><i class="fas fa-seedling" style="color: var(--p);"></i> Registrar Colheita</h3>
                <input type="hidden" id="venda-id">
                
                <label>Quantidade de Caixas</label>
                <input type="number" id="q" placeholder="Ex: 50" inputmode="numeric" onfocus="this.select()">
                
                <label>Pre√ßo por Caixa (R$)</label>
                <input type="number" id="p" placeholder="0,00" step="0.01" inputmode="decimal" onfocus="this.select()">
                
                <label>Data</label>
                <input type="date" id="dv">
                
                <button id="btn-acao-venda" class="btn-income" onclick="salvarVenda()"><i class="fas fa-check"></i> Confirmar Venda</button>
                <button id="btn-cancel-venda" class="btn-sec" style="display:none;" onclick="cancelarEdicao('vendas')"><i class="fas fa-undo-alt"></i> Cancelar</button>
            </div>
        </div>

        <div id="v-gasto" class="view">
            <div class="card">
                <h3 id="titulo-gasto"><i class="fas fa-tools" style="color: var(--expense);"></i> Registrar Despesa</h3>
                <input type="hidden" id="gasto-id">
                
                <label>Descri√ß√£o</label>
                <input type="text" id="d" placeholder="Ex: Adubo, Combust√≠vel..." autocomplete="off">
                
                <label>Valor (R$)</label>
                <input type="number" id="v" placeholder="0,00" step="0.01" inputmode="decimal" onfocus="this.select()">
                
                <label>Data</label>
                <input type="date" id="dg">
                
                <button id="btn-acao-gasto" class="btn-expense" onclick="salvarGasto()"><i class="fas fa-money-bill-wave"></i> Registrar Gasto</button>
                <button id="btn-cancel-gasto" class="btn-sec" style="display:none;" onclick="cancelarEdicao('gastos')"><i class="fas fa-undo-alt"></i> Cancelar</button>
            </div>
        </div>

        <div id="v-consulta" class="view">
            <div class="card">
                <h3><i class="fas fa-chart-line" style="color: var(--p);"></i> Desempenho</h3>
                <div id="info-safra-anual" style="font-size: 0.75rem; color: #666; margin-top: -10px; margin-bottom: 10px;">
                    Lucro Acumulado (Ano): <strong style="color: var(--p)">R$ 0,00</strong>
                </div>

                <select id="filtroMes" onchange="render()"></select>
                
                <div style="height:200px; width:100%; margin-top:10px;">
                    <canvas id="graficoLinha"></canvas>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-history"></i> Hist√≥rico</h3>
                <div id="lista-detalhada" class="list-container"></div>
            </div>

            <div class="card" style="display: flex; flex-direction: column; gap: 10px;">
                <div id="backup-alert" class="backup-alert">
                    <div>
                        <div style="font-weight:700; color:#1e40af; font-size:0.85rem">Backup Pendente</div>
                        <div style="font-size:0.75rem; color:#60a5fa">Recomendado fazer backup.</div>
                    </div>
                    <button style="width: auto; padding: 8px 16px; font-size: 0.75rem; background: #2563eb; color: white;" onclick="exportarManual()"><i class="fas fa-download"></i> BAIXAR</button>
                </div>
                
                <button class="btn-primary" onclick="abrirModalRelatorios()" style="background-color: #0d9488;">
                    <i class="fas fa-file-invoice"></i> Op√ß√µes de Relat√≥rios
                </button>
                
                <button class="btn-wpp" onclick="compartilharWhatsapp()"><i class="fab fa-whatsapp"></i> Enviar no WhatsApp</button>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="btn-sec" onclick="exportarManual()"><i class="fas fa-download"></i> Backup JSON</button>
                    <button class="btn-sec" onclick="document.getElementById('fileInput').click()"><i class="fas fa-upload"></i> Importar JSON</button>
                    <input type="file" id="fileInput" style="display:none" accept=".json" onchange="iniciarImportacao(event)">
                </div>

                <button class="btn-delete" onclick="confirmAction('Apagar Tudo', 'Tem certeza? Todos os dados ser√£o perdidos.', limparBancoDados, '‚ö†Ô∏è', '#ef4444')">
                    <i class="fas fa-trash-alt"></i> Resetar App
                </button>
            </div>
        </div>

        <div id="v-apoie" class="view">
            <div class="card">
                <h3><i class="fas fa-hand-holding-heart" style="color: #e11d48;"></i> Por que apoiar?</h3>
                
                <div class="info-section">
                    <p>O <b>Chuchuzeiro</b> n√£o √© apenas um controle de colheitas. √â um software √©tico, feito para o produtor rural que valoriza <b>privacidade, simplicidade e liberdade</b>.</p>
                    
                    <h4><i class="fas fa-user-shield"></i> Privacidade Radical</h4>
                    <p>A maioria dos apps envia seus dados financeiros para a nuvem. Aqui, usamos <b>IndexedDB</b> (banco de dados local). <b>Nenhuma informa√ß√£o sai do seu celular</b>. Nem mesmo n√≥s temos acesso.</p>

                    <h4><i class="fas fa-tachometer-alt"></i> Performance Extrema</h4>
                    <p>Todo o app roda com acelera√ß√£o de hardware (GPU). As telas s√£o fluidas e a bateria dura mais ‚Äì essencial para quem trabalha no campo.</p>

                    <h4><i class="fas fa-wifi-slash"></i> Soberania Digital (Offline)</h4>
                    <p>Sem internet? Sem problema. O Chuchuzeiro funciona no modo avi√£o, na ro√ßa ou no transporte da colheita. Seus backups (JSON) s√£o seus ‚Äì voc√™ decide onde guardar.</p>
                    
                    <div class="privacy-box" style="background: #fff1f2; border-color: #e11d48; color: #9f1239;">
                        <p><i class="fas fa-mug-hot"></i> <b>100% gratuito e sem an√∫ncios</b><br>
                        Este projeto √© mantido com doa√ß√µes de usu√°rios como voc√™. Desenvolver tecnologia agr√≠cola de qualidade exige centenas de horas. Se o Chuchuzeiro ajuda sua gest√£o, considere apoiar.</p>
                    </div>
                </div>
        
                <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 15px;">
                    <button class="btn-tutorial" onclick="openTutorialModal()">
                        <i class="fas fa-book-reader"></i> Tutorial: Conhe√ßa todos os recursos
                    </button>

                    <button class="btn-pix" onclick="openPixModal()">
                        <i class="fas fa-qrcode"></i> Apoiar via PIX (QR Code)
                    </button>

                    <button class="btn-mp" onclick="window.open('https://link.mercadopago.com.br/cuecasa', '_blank')">
                        <i class="fas fa-credit-card"></i> Apoiar via Cart√£o/MP
                    </button>
                    <button class="btn-wpp" onclick="window.open('https://wa.me/5547996057007?text=Quero%20suporte%20do%20app%20chuchuzeiro', '_blank')">
                        <i class="fab fa-whatsapp"></i> Contato do Desenvolvedor
                    </button>
                </div>
                
                <div style="text-align: center; margin-top: 20px; color: #9ca3af; font-size: 0.7rem;">
                    Vers√£o 2.0 ‚Ä¢ Feito com üå± para agricultura familiar<br>
                    <i class="fas fa-shield-alt"></i> Dados 100% no seu dispositivo
                </div>
            </div>
        </div>

    </div>

    <nav>
        <div class="nav-buttons">
            <div class="tab active" onclick="navTo('v-venda',this)"><i class="fas fa-seedling"></i><span>Colheita</span></div>
            <div class="tab" onclick="navTo('v-gasto',this)"><i class="fas fa-tools"></i><span>Despesas</span></div>
            <div class="tab" onclick="navTo('v-consulta',this)"><i class="fas fa-chart-bar"></i><span>Relat√≥rios</span></div>
            <div class="tab" onclick="navTo('v-apoie',this)"><i class="fas fa-heart"></i><span>Apoie</span></div>
        </div>
    </nav>

    <div id="custom-modal" class="modal-overlay">
        <div class="modal-box">
            <span class="modal-icon" id="modal-icon">ü§î</span>
            <div class="modal-title" id="modal-title">T√≠tulo</div>
            <div class="modal-desc" id="modal-desc">Descri√ß√£o</div>
            <div class="modal-actions">
                <button class="btn-sec" id="modal-btn-cancel">Cancelar</button>
                <button class="btn-v" id="modal-btn-confirm">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="toast">Notifica√ß√£o</div>

    <script>
        // -------------------- PREVEN√á√ÉO DE MULTIPLAS ABAS (BroadcastChannel) --------------------
        const channel = new BroadcastChannel('chuchuzeiro_auth');
        channel.postMessage('ping');
        channel.onmessage = (event) => {
            if (event.data === 'ping') channel.postMessage('pong');
            else if (event.data === 'pong') {
                document.body.innerHTML = '<div style="display:flex;height:100vh;align-items:center;justify-content:center;"><h1>‚ö†Ô∏è App j√° aberto</h1></div>';
                window.stop();
            }
        };

        // -------------------- VAR GLOBAIS --------------------
        let db;
        let chartInstance;
        const DB_NAME = "ChuchuProDB_v2";
        const DB_VERSION = 1;
        const FORMAT_BRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
        const BACKUP_KEY = "chuchu_last_backup_date";
        const AUTO_BACKUP_KEY = "chuchu_auto_mirror";
        let pendingAction = null;

        // -------------------- UTILIT√ÅRIOS --------------------
        function removerAcentos(str) {
            if (!str) return "";
            return str.normalize('NFD').replace(/[\u0300-\u036f]/g, "");
        }
        function getUserName() {
            return localStorage.getItem('chuchuzeiro_user_name') || "Produtor";
        }
        function getSafeFileName() {
            return getUserName().replace(/[^a-z0-9]/gi, '_');
        }

        // -------------------- MODAIS (boas vindas, tutorial, pix) --------------------
        function checkUser() {
            const user = localStorage.getItem('chuchuzeiro_user_name');
            if (!user) {
                document.getElementById('welcome-modal').style.display = 'flex';
            } else {
                updateUserUI(user);
            }
        }
        function salvarUsuario() {
            const name = document.getElementById('user-name-input').value.trim();
            if (!name) return alert("Por favor, digite um nome.");
            localStorage.setItem('chuchuzeiro_user_name', name);
            document.getElementById('welcome-modal').style.display = 'none';
            updateUserUI(name);
            showToast(`Bem-vindo, ${name}!`, 'success');
        }
        function updateUserUI(name) {
            const el = document.getElementById('user-greeting');
            el.innerText = `üå± Ol√°, ${name}`;
            el.style.display = 'block';
        }

        function openTutorialModal() { document.getElementById('tutorial-modal').style.display = 'flex'; }
        function closeTutorialModal() { document.getElementById('tutorial-modal').style.display = 'none'; }
        function openPixModal() { document.getElementById('pix-modal').style.display = 'flex'; }
        function closePixModal() { document.getElementById('pix-modal').style.display = 'none'; }

        // --- NOVAS FUN√á√ïES MODAL RELATORIOS ---
        function abrirModalRelatorios() {
            document.getElementById('modal-relatorios').style.display = 'flex';
        }
        function fecharModalRelatorios() {
            document.getElementById('modal-relatorios').style.display = 'none';
        }

        // -------------------- TOAST --------------------
        function showToast(msg, type = 'success') {
            const t = document.getElementById("toast");
            t.innerHTML = (type === 'success' ? '‚úÖ ' : '‚ö†Ô∏è ') + msg;
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 3000);
        }

        // -------------------- CONFIRMA√á√ÉO MODAL --------------------
        function confirmAction(title, desc, action, icon = '‚ö†Ô∏è', confirmColor = null) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-desc').innerText = desc;
            document.getElementById('modal-icon').innerText = icon;
            const btn = document.getElementById('modal-btn-confirm');
            btn.style.background = confirmColor || 'var(--p)';
            pendingAction = action;
            document.getElementById('custom-modal').classList.add('open');
        }
        function closeModal() {
            document.getElementById('custom-modal').classList.remove('open');
            pendingAction = null;
        }
        document.getElementById('modal-btn-cancel').onclick = closeModal;
        document.getElementById('modal-btn-confirm').onclick = () => {
            if(pendingAction) pendingAction();
            closeModal();
        };

        // -------------------- INDEXED DB (igual ao original) --------------------
        function initDB() {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = e => {
                db = e.target.result;
                if(!db.objectStoreNames.contains("vendas")) db.createObjectStore("vendas", { keyPath: "id", autoIncrement: true });
                if(!db.objectStoreNames.contains("gastos")) db.createObjectStore("gastos", { keyPath: "id", autoIncrement: true });
            };
            request.onsuccess = e => { 
                 db = e.target.result; 
                 popularFiltroMeses();
                render();
                verificarBackupSemanal();
            };
        }

        function transaction(storeName, mode) { return db.transaction(storeName, mode).objectStore(storeName); }
        function getAll(storeName) {
            return new Promise(resolve => {
                if(!db) return resolve([]);
                const req = transaction(storeName, "readonly").getAll();
                req.onsuccess = () => resolve(req.result);
            });
        }

        // -------------------- DATAS --------------------
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dv').value = today;
            document.getElementById('dg').value = today;
        }
        function isDataFutura(dateString) {
            const inputDate = new Date(dateString + 'T00:00:00');
            const today = new Date(); today.setHours(0,0,0,0);
            return inputDate > today;
        }

        // -------------------- CRUD VENDAS --------------------
        function salvarVenda() {
            const id = document.getElementById('venda-id').value;
            const q = parseFloat(document.getElementById('q').value);
            const p = parseFloat(document.getElementById('p').value);
            const dt = document.getElementById('dv').value;
            if(!q || !p || !dt) return showToast("Preencha todos os campos", "error");
            if(isDataFutura(dt)) return showToast("Data futura n√£o permitida", "error");
            const item = { q, p, dt, t: (q * p) };
            if(id) item.id = parseInt(id);
            transaction("vendas", "readwrite").put(item).onsuccess = () => {
                showToast(id ? "Venda atualizada" : "Venda registrada", "success");
                espelharDadosAutomatico();
                resetForm('vendas');
                render();
            };
        }

        function salvarGasto() {
            const id = document.getElementById('gasto-id').value;
            const d = document.getElementById('d').value;
            const v = parseFloat(document.getElementById('v').value);
            const dt = document.getElementById('dg').value;
            if(!d || !v || !dt) return showToast("Preencha todos os campos", "error");
            if(isDataFutura(dt)) return showToast("Data futura n√£o permitida", "error");
            const item = { d, v, dt };
            if(id) item.id = parseInt(id);
            transaction("gastos", "readwrite").put(item).onsuccess = () => {
                showToast(id ? "Gasto atualizado" : "Gasto registrado", "success");
                espelharDadosAutomatico();
                resetForm('gastos');
                render();
            };
        }

        // -------------------- RESET E CANCEL --------------------
        function resetForm(type) {
            setTodayDate();
            if(type === 'vendas') {
                document.getElementById('venda-id').value = "";
                document.getElementById('q').value = "";
                document.getElementById('p').value = "";
                document.getElementById('titulo-venda').innerHTML = '<i class="fas fa-seedling" style="color: var(--p);"></i> Registrar Colheita';
                const btn = document.getElementById('btn-acao-venda');
                btn.innerHTML = '<i class="fas fa-check"></i> Confirmar Venda';
                btn.className = "btn-income";
                document.getElementById('btn-cancel-venda').style.display = 'none';
            } else {
                document.getElementById('gasto-id').value = "";
                document.getElementById('d').value = "";
                document.getElementById('v').value = "";
                document.getElementById('titulo-gasto').innerHTML = '<i class="fas fa-tools" style="color: var(--expense);"></i> Registrar Despesa';
                const btn = document.getElementById('btn-acao-gasto');
                btn.innerHTML = '<i class="fas fa-money-bill-wave"></i> Registrar Gasto';
                btn.className = "btn-expense";
                document.getElementById('btn-cancel-gasto').style.display = 'none';
            }
        }

        function cancelarEdicao(type) { resetForm(type); }

        // -------------------- EDI√á√ÉO --------------------
        function editarItem(type, id) {
            transaction(type, "readonly").get(id).onsuccess = (e) => {
                const data = e.target.result;
                if (type === 'vendas') {
                    document.getElementById('venda-id').value = data.id;
                    document.getElementById('q').value = data.q;
                    document.getElementById('p').value = data.p;
                    document.getElementById('dv').value = data.dt;
                    document.getElementById('titulo-venda').innerHTML = '<i class="fas fa-edit"></i> Editando Venda';
                    const btn = document.getElementById('btn-acao-venda');
                    btn.innerHTML = '<i class="fas fa-sync-alt"></i> Salvar Altera√ß√µes';
                    btn.className = "btn-update";
                    document.getElementById('btn-cancel-venda').style.display = 'block';
                    navTo('v-venda', document.querySelectorAll('.tab')[0]);
                } else {
                    document.getElementById('gasto-id').value = data.id;
                    document.getElementById('d').value = data.d;
                    document.getElementById('v').value = data.v;
                    document.getElementById('dg').value = data.dt;
                    document.getElementById('titulo-gasto').innerHTML = '<i class="fas fa-edit"></i> Editando Gasto';
                    const btn = document.getElementById('btn-acao-gasto');
                    btn.innerHTML = '<i class="fas fa-sync-alt"></i> Salvar Altera√ß√µes';
                    btn.className = "btn-update";
                    document.getElementById('btn-cancel-gasto').style.display = 'block';
                    navTo('v-gasto', document.querySelectorAll('.tab')[1]);
                }
            };
        }

        function apagarItem(type, id) {
            transaction(type, "readwrite").delete(id).onsuccess = () => {
                showToast("Item removido", "success");
                espelharDadosAutomatico();
                render();
            };
        }

        // -------------------- RENDERIZA√á√ÉO (igual original, adaptada para novos cards) --------------------
        async function render() {
            if (!db) return;
            if (document.getElementById('filtroMes').options.length === 0) await popularFiltroMeses();
            const filtro = document.getElementById('filtroMes').value;
            const allV = await getAll("vendas");
            const allG = await getAll("gastos");
            const v = allV.filter(i => i.dt.startsWith(filtro));
            const g = allG.filter(i => i.dt.startsWith(filtro));

            const tCx = v.reduce((sum, i) => sum + i.q, 0);
            const tV = v.reduce((sum, i) => sum + i.t, 0);
            const tG = g.reduce((sum, i) => sum + i.v, 0);
            const saldo = tV - tG;
            const margin = tV > 0 ? ((saldo / tV) * 100).toFixed(0) : 0;

            document.getElementById('dash-cx').innerText = tCx;
            document.getElementById('dash-rs').innerText = FORMAT_BRL.format(saldo);
            document.getElementById('dash-rs').style.color = saldo >= 0 ? '#1b5e20' : '#c62828';
            document.getElementById('dash-margin').innerText = margin + "%";
            document.getElementById('dash-margin').style.color = margin > 0 ? 'var(--p)' : (margin < 0 ? 'var(--expense)' : '#666');
            document.getElementById('dash-in').innerText = FORMAT_BRL.format(tV);
            document.getElementById('dash-out').innerText = FORMAT_BRL.format(tG);

            // CALCULO ANUAL DISCRETO
            const anoAtual = new Date().getFullYear().toString();
            const totalVendaAno = allV.reduce((acc, i) => i.dt.startsWith(anoAtual) ? acc + i.t : acc, 0);
            const totalGastoAno = allG.reduce((acc, i) => i.dt.startsWith(anoAtual) ? acc + i.v : acc, 0);
            const lucroAno = totalVendaAno - totalGastoAno;
            
            const elLucroAno = document.querySelector('#info-safra-anual strong');
            if(elLucroAno) {
                elLucroAno.innerText = FORMAT_BRL.format(lucroAno);
                elLucroAno.style.color = lucroAno >= 0 ? 'var(--p)' : 'var(--expense)';
            }

            // Lista
            const lista = document.getElementById('lista-detalhada');
            lista.innerHTML = '';
            const combined = [
                ...v.map(i => ({...i, type: 'vendas'})),
                ...g.map(i => ({...i, type: 'gastos'}))
            ].sort((a,b) => new Date(b.dt) - new Date(a.dt) || b.id - a.id);

            if (combined.length === 0) {
                lista.innerHTML = '<div class="empty-state" style="text-align:center; padding:20px; color:#9ca3af;">üì≠ Nenhum registro neste m√™s.</div>';
            } else {
                combined.forEach(item => {
                    const el = criarElementoLista(item);
                    lista.appendChild(el);
                });
            }
            atualizarGrafico(v, g);
        }

        function criarElementoLista(item) {
            const isV = item.type === 'vendas';
            const val = isV ? item.t : item.v;
            const dia = item.dt.split('-')[2];
            const mesAbrev = new Date(item.dt).toLocaleString('pt-BR', {month:'short'}).replace('.','');
            
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `
                <div class="item-date-box">
                    <span>${mesAbrev}</span>
                    <strong>${dia}</strong>
                </div>
                <div class="item-desc">
                    <b>${isV ? item.q + ' Caixas' : item.d}</b>
                    <small>${isV ? FORMAT_BRL.format(item.p) + '/un' : 'Despesa'}</small>
                </div>
                <div class="item-value">
                    <b style="color:${isV?'var(--income)':'var(--expense)'}">${isV?'+':'-'} ${FORMAT_BRL.format(val)}</b>
                    <div class="actions" style="margin-top:6px; display:flex; gap:8px; justify-content:flex-end;">
                        <span class="btn-mini edit" style="background:#e0f2fe; color:#0284c7; padding:4px 10px; border-radius:6px; font-size:0.7rem; font-weight:600; cursor:pointer;"><i class="fas fa-pen"></i> Editar</span>
                        <span class="btn-mini del" style="background:#fee2e2; color:#dc2626; padding:4px 10px; border-radius:6px; font-size:0.7rem; font-weight:600; cursor:pointer;"><i class="fas fa-trash"></i> Excluir</span>
                    </div>
                </div>
            `;
            
            div.querySelector('.edit').onclick = (e) => { e.stopPropagation(); editarItem(item.type, item.id); };
            div.querySelector('.del').onclick = (e) => { e.stopPropagation(); confirmAction("Apagar Item", "Deseja remover este registro?", () => apagarItem(item.type, item.id), 'üóëÔ∏è', '#ef4444'); };
            
            return div;
        }

        // -------------------- GR√ÅFICO DE LINHA --------------------
        function atualizarGrafico(vendas, gastos) {
            const ctx = document.getElementById('graficoLinha').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            
            const map = {};
            vendas.forEach(i => { const d = parseInt(i.dt.split('-')[2]); map[d] = (map[d] || 0) + i.q; });
            const labels = Object.keys(map).map(Number).sort((a,b)=>a-b);
            
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(27, 94, 32, 0.2)');
            gradient.addColorStop(1, 'rgba(27, 94, 32, 0.0)');

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Caixas',
                        data: labels.map(d=>map[d]),
                        borderColor: '#1b5e20',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#1b5e20',
                        pointRadius: 4,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                    scales: { y: { beginAtZero: true, grid: { color: '#f3f4f6' }, ticks: { font: {size: 10} } }, x: { grid: { display: false }, ticks: { font: {size: 10} } } },
                    interaction: { mode: 'nearest', axis: 'x', intersect: false }
                }
            });
        }

        // -------------------- FILTRO M√äS --------------------
        async function popularFiltroMeses() {
            const vendas = await getAll("vendas");
            const gastos = await getAll("gastos");
            const todos = [...vendas, ...gastos];
            const meses = [...new Set(todos.map(i => i.dt.slice(0, 7)))].sort().reverse();
            
            const select = document.getElementById('filtroMes');
            const valorAtual = select.value;
            select.innerHTML = "";

            if(meses.length === 0) { meses.push(new Date().toISOString().slice(0,7)); }

            meses.forEach(mes => {
                const [ano, m] = mes.split('-');
                const nomeMes = new Date(ano, m - 1).toLocaleString('pt-BR', { month: 'long' });
                const opt = document.createElement('option');
                opt.value = mes;
                opt.text = `${nomeMes.charAt(0).toUpperCase() + nomeMes.slice(1)} ${ano}`;
                select.appendChild(opt);
            });

            if(meses.includes(valorAtual)) select.value = valorAtual;
        }

        // -------------------- BACKUP AUTOM√ÅTICO E ALERTA --------------------
        async function espelharDadosAutomatico() {
            try {
                const v = await getAll("vendas");
                const g = await getAll("gastos");
                localStorage.setItem(AUTO_BACKUP_KEY, JSON.stringify({vendas: v, gastos: g}));
            } catch (e) { console.error("Erro backup auto", e); }
        }

        function verificarBackupSemanal() {
            const lastBackup = localStorage.getItem(BACKUP_KEY);
            const elLabel = document.getElementById('lbl-last-backup'); // n√£o usado, mas mant√©m
            
            if (lastBackup) {
                const diffDays = Math.ceil(Math.abs(new Date() - new Date(lastBackup)) / (86400000)); 
                if (diffDays >= 7) document.getElementById('backup-alert').style.display = 'flex';
            } else {
                getAll("vendas").then(v => { if (v.length > 0) document.getElementById('backup-alert').style.display = 'flex'; });
            }
        }

        // -------------------- PDF MENSAL (j√° existente) --------------------
        async function gerarRelatorioPDF() {
            fecharModalRelatorios();
            showToast("Gerando PDF Mensal...");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const filtro = document.getElementById('filtroMes').value;
            const [ano, mes] = filtro.split('-');
            const nomeMes = new Date(ano, mes - 1).toLocaleString('pt-BR', { month: 'long' }).toUpperCase();
            
            const allV = await getAll("vendas");
            const allG = await getAll("gastos");
            const v = allV.filter(i => i.dt.startsWith(filtro));
            const g = allG.filter(i => i.dt.startsWith(filtro));
            const totalV = v.reduce((s, i) => s + i.t, 0);
            const totalG = g.reduce((s, i) => s + i.v, 0);
            const saldo = totalV - totalG;
            const totalCx = v.reduce((s, i) => s + i.q, 0);

            // Cabe√ßalho verde
            doc.setFillColor(27, 94, 32); 
            doc.rect(0, 0, doc.internal.pageSize.getWidth(), 45, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont("helvetica", 'bold');
            doc.text("CHUCHUZEIRO", doc.internal.pageSize.getWidth()/2, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.setFont("helvetica", 'normal');
            doc.text(`${removerAcentos(getUserName())} ‚Ä¢ ${nomeMes}/${ano}`, doc.internal.pageSize.getWidth()/2, 35, { align: 'center' });
            
            let yPos = 55;
            doc.setFillColor(232, 245, 233); doc.rect(14, yPos, 55, 25, 'F');
            doc.setTextColor(27, 94, 32); doc.setFontSize(10); doc.text("ENTRADAS", 18, yPos+8);
            doc.setFontSize(12); doc.text(FORMAT_BRL.format(totalV), 18, yPos+18);
            
            doc.setFillColor(255, 235, 238); doc.rect(77, yPos, 55, 25, 'F');
            doc.setTextColor(198, 40, 40); doc.setFontSize(10); doc.text("SA√çDAS", 81, yPos+8);
            doc.setFontSize(12); doc.text(FORMAT_BRL.format(totalG), 81, yPos+18);
            
            doc.setFillColor(243, 244, 246); doc.rect(140, yPos, 55, 25, 'F');
            doc.setTextColor(31, 41, 55); doc.setFontSize(10); doc.text("SALDO FINAL", 144, yPos+8);
            doc.setFontSize(12); doc.text(FORMAT_BRL.format(saldo), 144, yPos+18);

            doc.setTextColor(100); doc.setFontSize(9);
            doc.text(`Total de Caixas: ${totalCx}`, 14, yPos + 35);
            doc.text(`Margem de Lucro: ${totalV > 0 ? ((saldo/totalV)*100).toFixed(0) : 0}%`, 14, yPos + 42);

            const tableBody = [
                ...v.map(i => [new Date(i.dt).toLocaleDateString('pt-BR'), `${i.q} Caixas`, `R$ ${i.p.toFixed(2)}`, `+ ${FORMAT_BRL.format(i.t)}`]),
                ...g.map(i => [new Date(i.dt).toLocaleDateString('pt-BR'), i.d, '-', `- ${FORMAT_BRL.format(i.v)}`])
            ].sort((a,b) => b[0].split('/').reverse().join('-').localeCompare(a[0].split('/').reverse().join('-')));
            
            if(tableBody.length > 0) {
                doc.autoTable({
                    startY: yPos + 50,
                    head: [['Data', 'Descri√ß√£o', 'Unit√°rio/Obs', 'Valor']],
                    body: tableBody,
                    theme: 'striped',
                    headStyles: { fillColor: [27, 94, 32], textColor: 255, fontStyle: 'bold' },
                    columnStyles: { 0: { cellWidth: 30 }, 3: { halign: 'right', fontStyle: 'bold' } }
                });
            }
            doc.save(`Chuchuzeiro_${getSafeFileName()}_${filtro}.pdf`);
            showToast("PDF salvo!");
        }

        // -------------------- PDF SAFRA ANUAL (CORRIGIDO) --------------------
        async function gerarRelatorioSafraPDF() {
            fecharModalRelatorios();
            showToast("Gerando PDF Safra...");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const anoAtual = new Date().getFullYear();
            const allV = await getAll("vendas");
            const allG = await getAll("gastos");
            
            // Dados agregados por m√™s
            const mesesDados = Array(12).fill(null).map(() => ({ q: 0, v: 0, g: 0 }));
            
            allV.forEach(v => {
                if (v.dt.startsWith(anoAtual)) {
                    const m = parseInt(v.dt.split('-')[1]) - 1;
                    mesesDados[m].q += v.q;
                    mesesDados[m].v += v.t;
                }
            });
            allG.forEach(g => {
                if (g.dt.startsWith(anoAtual)) {
                    const m = parseInt(g.dt.split('-')[1]) - 1;
                    mesesDados[m].g += g.v;
                }
            });

            // Achar melhor m√™s de produ√ß√£o
            let maxQ = 0;
            mesesDados.forEach(m => { if(m.q > maxQ) maxQ = m.q; });

            // Cabe√ßalho
            doc.setFillColor(27, 94, 32); 
            doc.rect(0, 0, doc.internal.pageSize.getWidth(), 45, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont("helvetica", 'bold');
            doc.text("SAFRA ANUAL", doc.internal.pageSize.getWidth()/2, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.setFont("helvetica", 'normal');
            doc.text(`${removerAcentos(getUserName())} ‚Ä¢ Ano: ${anoAtual}`, doc.internal.pageSize.getWidth()/2, 35, { align: 'center' });

            const tableBody = [];
            const nomesMeses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            
            let totalAnoQ = 0;
            let totalAnoLucro = 0;
            let bestMonthIndex = -1; // Para pintar a linha

            mesesDados.forEach((d, i) => {
                const lucro = d.v - d.g;
                totalAnoQ += d.q;
                totalAnoLucro += lucro;
                
                let mesNome = nomesMeses[i];
                // Removemos o emoji aqui para corrigir o erro de texto, usamos texto puro
                if (d.q > 0 && d.q === maxQ) {
                    mesNome += " (Melhor Safra)";
                    bestMonthIndex = i;
                }

                tableBody.push([
                    mesNome,
                    d.q + " cx",
                    FORMAT_BRL.format(d.v),
                    FORMAT_BRL.format(d.g),
                    FORMAT_BRL.format(lucro)
                ]);
            });

            // Linha de Total
            tableBody.push([
                "TOTAL ANUAL", 
                totalAnoQ + " cx", 
                "-", 
                "-", 
                FORMAT_BRL.format(totalAnoLucro)
            ]);

            doc.autoTable({
                startY: 55,
                head: [['M√™s', 'Produ√ß√£o', 'Receita', 'Despesa', 'Lucro']],
                body: tableBody,
                theme: 'striped',
                headStyles: { fillColor: [27, 94, 32], textColor: 255, fontStyle: 'bold' },
                columnStyles: { 
                    0: { fontStyle: 'bold' },
                    4: { halign: 'right', fontStyle: 'bold' } 
                },
                didParseCell: function(data) {
                    // Pintar linha de total em cinza
                    if (data.row.index === tableBody.length - 1) {
                        data.cell.styles.fillColor = [220, 220, 220];
                        data.cell.styles.fontStyle = 'bold';
                    }
                    // Pintar linha da MELHOR SAFRA em dourado suave para destacar sem emoji
                    if (bestMonthIndex !== -1 && data.row.index === bestMonthIndex) {
                        data.cell.styles.fillColor = [255, 248, 220]; // Dourado bem claro
                        data.cell.styles.textColor = [180, 83, 9]; // Marrom dourado escuro
                    }
                }
            });

            doc.save(`Chuchuzeiro_Safra_${anoAtual}.pdf`);
            showToast("PDF Safra salvo!");
        }

        // -------------------- COMPARTILHAR WHATSAPP --------------------
        async function compartilharWhatsapp() {
            showToast("Preparando...");
            const filtro = document.getElementById('filtroMes').value;
            const [ano, mes] = filtro.split('-');
            const nomeMes = new Date(ano, mes - 1).toLocaleString('pt-BR', { month: 'long' }).toUpperCase();
            
            const allV = await getAll("vendas");
            const allG = await getAll("gastos");
            const v = allV.filter(i => i.dt.startsWith(filtro));
            const g = allG.filter(i => i.dt.startsWith(filtro));
            
            const totalV = v.reduce((s, i) => s + i.t, 0);
            const totalG = g.reduce((s, i) => s + i.v, 0);
            const saldo = totalV - totalG;
            const totalCx = v.reduce((s, i) => s + i.q, 0);

            let msg = `*CHUCHUZEIRO - RELAT√ìRIO*\n`;
            msg += `üë§ ${getUserName()}\nüóì ${nomeMes}/${ano}\n\n`;
            msg += `üì¶ Caixas: ${totalCx}\n`;
            msg += `‚úÖ Entradas: ${FORMAT_BRL.format(totalV)}\n`;
            msg += `üîª Sa√≠das: ${FORMAT_BRL.format(totalG)}\n`;
            msg += `üí∞ *Saldo: ${FORMAT_BRL.format(saldo)}*\n`;
            msg += `üìä Margem: ${totalV > 0 ? ((saldo/totalV)*100).toFixed(0) : 0}%\n\n`;
            msg += `_Gerado pelo App Chuchuzeiro_`;

            const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        }

        // -------------------- EXPORTAR/IMPORTAR BACKUP --------------------
        async function exportarManual() {
            const [v, g] = await Promise.all([getAll("vendas"), getAll("gastos")]);
            const dataHoje = new Date().toISOString().split('T')[0];
            const blob = new Blob([JSON.stringify({vendas: v, gastos: g})], {type: "application/json"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `Chuchuzeiro_Backup_${getSafeFileName()}_${dataHoje}.json`;
            a.click();
            
            localStorage.setItem(BACKUP_KEY, new Date().toISOString());
            document.getElementById('backup-alert').style.display = 'none';
            showToast("Backup salvo!");
        }

        function iniciarImportacao(e) {
            const file = e.target.files[0];
            if(!file) return;
            
            confirmAction("Restaurar Dados", "Isso ir√° mesclar os dados do arquivo com os dados atuais.", () => {
                const reader = new FileReader();
                reader.onload = f => {
                    try {
                        const data = JSON.parse(f.target.result);
                        const txV = db.transaction("vendas", "readwrite");
                        data.vendas.forEach(i => { delete i.id; txV.objectStore("vendas").put(i); });
                        const txG = db.transaction("gastos", "readwrite");
                        data.gastos.forEach(i => { delete i.id; txG.objectStore("gastos").put(i); });
                        txG.oncomplete = () => { showToast("Dados restaurados!"); espelharDadosAutomatico(); render(); };
                    } catch(err) { showToast("Arquivo inv√°lido", "error"); }
                };
                reader.readAsText(file);
            }, 'üì•');
        }

        function limparBancoDados() {
            const tx = db.transaction(["vendas", "gastos"], "readwrite");
            tx.objectStore("vendas").clear();
            tx.objectStore("gastos").clear();
            tx.oncomplete = () => { 
                 localStorage.removeItem(AUTO_BACKUP_KEY); 
                 showToast("Tudo limpo!"); 
                 render(); 
             };
        }

        // -------------------- NAVEGA√á√ÉO ENTRE ABAS --------------------
        function navTo(viewId, tabEl) {
            document.querySelectorAll('.view, .tab').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            tabEl.classList.add('active');
            if(viewId === 'v-consulta') {
                popularFiltroMeses().then(render);
            }
        }

        // -------------------- INICIALIZA√á√ÉO --------------------
        window.onload = () => {
            initDB();
            setTodayDate();
            checkUser();
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js').catch(() => {});
            }
        };
    </script>
</body>
</html>
